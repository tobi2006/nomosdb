{% extends "base.html" %}
{% load custom_filters %}

{% block style %}

.glyphicon
{
    cursor: pointer;
}
.input-group
{
    width: 120px;
}

{% endblock %}

{% block formstart %}
    <form action="" method="post" accept-charset="utf-8" role="form" id="form">
    {% csrf_token %}
{% endblock %} 

{% block content %}

<h2>
    Marks for {{ module.title }} ({{ module.year }})
</h2>

<table id ="sortable_table" class="table table-striped table-sortable">
    <thead>
        <tr>
            <th>
                Student
            </th>
            {% for assessment in module.all_assessment_titles %}
                <th>
                    {{ assessment.0 }}{% if assessment.1 %} ({{ assessment.1 }} %){% endif %}
                </th>
            {% endfor %}
            <th>
                Module Mark
            </th>
        </tr>
    </thead>
    <tbody>
    {% for performance in performances %}
        <tr>
            <td>
                <label>{{ performance.student.short_name }}</label>
            </td>
            {% for result in performance.all_results_as_slug_tpls %}
            <td>
                <div class="input-group">
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-minus-sign" id="{{ performance.student.student_id }}_minus_{{ result.0 }}"></span>
                    </span>
                    <input class="form-control mark_field {{ performance.student.student_id }}_input" id="{{ performance.student.student_id }}_1" name="{{ performance.student.student_id }}_{{ result.0 }}" value="{{ result.1 }}">
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-plus-sign" id="{{ performance.student.student_id }}_plus_{{ result.0 }}"></span>
                    </span>
                </div>
                (original: {{ result.1 }}
                <span class="help-block" id="{{ performance.student.student_id }}_error_{{ result.0 }}"></span>
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<input type="submit" value="Save Marks" class="btn btn-default" align=right>

{% endblock %}

{% block formend %}
</form>
{% endblock %}

{% block scripts %}

<script type="text/javascript">

$(document).ready(function () {

    function value(assessment) {
        {% if module.assessment_1_title %}
            var value_1 = parseInt({{ module.assessment_1_value }});
        {% else %}
            var value_1 = 0;
        {% endif %}
        {% if module.assessment_2_title %}
            var value_2 = parseInt({{ module.assessment_2_value }});
        {% else %}
            var value_2 = 0;
        {% endif %}
        {% if module.assessment_3_title %}
            var value_3 = parseInt({{ module.assessment_3_value }});
        {% else %}
            var value_3 = 0;
        {% endif %}
        {% if module.assessment_4_title %}
            var value_4 = parseInt({{ module.assessment_4_value }});
        {% else %}
            var value_4 = 0;
        {% endif %}
        {% if module.assessment_5_title %}
            var value_5 = parseInt({{ module.assessment_5_value }});
        {% else %}
            var value_5 = 0;
        {% endif %}
        {% if module.assessment_6_title %}
            var value_6 = parseInt({{ module.assessment_6_value }});
        {% else %}
            var value_6 = 0;
        {% endif %}
        {% if module.exam_value %}
            var value_exam = parseInt({{ module.exam_value }});
        {% else %}
            var value_exam = 0;
        {% endif %}
        switch(assessment) {
            case '1':
                returnvalue = value_1;
                break;
            case '2':
                returnvalue = value_2;
                break;
            case '3':
                returnvalue = value_3;
                break;
            case '4':
                returnvalue = value_4;
                break;
            case '5':
                returnvalue = value_5;
                break;
            case '6':
                returnvalue = value_6;
                break;
            case 'exam':
                returnvalue = value_exam;
                break;
        };
        return returnvalue;
    };

    function validate(student_id) {
        var valid = true;
        $('.' + student_id + '_input').each(function () { 
            var mark = parseInt($(this).val());
            var assessment = $(this).attr('id').split('_').pop();
            var error_element = '#' + student_id + '_error_' + assessment;
            if (isNaN(mark)) {
                var errortext = 'Please enter a number';
                valid = false;
            }
            else if (mark > 99) {
                var errortext = 'The mark should not exceed 100';
                valid = false;
            }
            else {
                var errortext = '';
            };
            $(error_element).text(errortext);
        });
        return valid;
    };

    function calculate_average(student_id) {

        var sum = 0;
        $('.' + student_id + '_input').each(function () { 
            var mark = parseInt($(this).val());
            var assessment = $(this).attr('id').split('_').pop()
            var weighted = mark * value(assessment);
            sum = sum + weighted;
        });
        var average = sum / 100;
        rounded_average = Math.round(average)
        insert = '<b>' + rounded_average + '</b>';
        $('#' + student_id + '_average').html(insert);
    }; 

    $('.glyphicon').click(function() {
        var this_id = $(this).attr("id");
        var this_list = this_id.split("_");
        var student_id = this_list[0];
        element_to_change = '#' + student_id + '_' + this_list[2];
        current = parseInt($(element_to_change).val());
        if (this_list[1] == 'plus') {
            new_value = current + 1;
            if (new_value > 100) {
                new_value = 100;
            };
        }
        else {
            new_value = current - 1;
            if (new_value < 0) {
                new_value = 0;
            };
        };
        $(element_to_change).val(new_value);
        calculate_average(student_id);
    });

    $('.form-control').change(function () {
        var student_id = $(this).attr('id').split('_').shift()
        if (validate(student_id)) {
            calculate_average(student_id);
        };
    });

}); 
</script>

{% endblock %}
